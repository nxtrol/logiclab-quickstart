.. _logiclab-fieldbus-ethercat:

EtherCAT现场总线
==================

EtherCAT是高性能工业实时以太网总线，可以通过标准以太网接口将大量I/O模块、伺服驱动器、传感器等等EtherCAT从站设备连接至工业PLC控制器、运动控制器、CNC数控机床、机器人控制器等等设备。

.. contents:: 本章节内容目录
   :local:
   :backlinks: none
   :depth: 3

基本概念
--------------------
EtherCAT从站使用ESI(EtherCAT Slave Information)文件描述，它采用XML格式描述所有的设备特点以及如何与EtherCAT主站通讯。

ESI文件格式由ETG(EtherCAT Technology Group)组织采用的ETG.2000标准进行规范化，单个ESI文件可以包含一个或者多个从站设备与版本，他们通常由从站设备厂商直接提供。

整个EtherCAT网络配置的输出是一个XML文件，需要由EtherCAT主站进行加载与管理，这个配置文件叫做ENI(EtherCAT Network Information)文件。ENI文件格式需要符合ETG.2100标准。

EtherCAT主站与从站之间的通过EtherCAT数据帧进行数据交互，这些数据帧是一些网络上的特殊以太网帧。EtherCAT数据帧由主站出发，经过每一个从站后再回到EtherCAT主站，每一个EtherCAT数据帧都包含一个或者多个EtherCAT命令。
* 周期型数据帧：按照指定周期有EtherCAT主站发出的确定性实时数据帧，包含与所有EtherCAT从站进行交换的过程数据，这些数据以PDOs(Process data objects)方式组织，包含了对象字典的数据值。
* 非周期型数据帧：按需进行发送并且用于实现服务的命令，例如：通过SDOs (Service data objects)读取一次对象字典数据。

EtherCAT网络中经常用到的一个技术是分布式时钟DC(Distributed clock): 让EtherCAT主站与所有从站的时钟完美同步,通常情况下第一个支持DC功能的从站将会被用于整个网络的DC参考时钟, 它将负责同步所有的EtherCAT从站与EtherCAT主站以及EtherCAT主站中PLC的时序。

EtherCAT主站与从站同时都包含状态机用于定义在启动以及运行阶段的状态，它们包括：
* Init: 初始化状态
* Boot: 固件加载、升级或者其他维护状态
* PreOp: 预运行状态，主从站之间没有数据交换
* SafeOp: 安全运行状态, 只有从站到主站的输入数据进行交互
* Op: 正常运行状态, 所有输入与输出的数据交换正常进行

每一个EtherCAT从站包含一个EtherCAT从站控制器ESC(EtherCAT Slave Controller)从站芯片，这个芯片的集成电路遵循EtherCAT总线规范进行通讯管理。

一个ESC包含多个同步管理器SM(Sync Managers)，同步管理器是用于管理过程数据一致性以及内部通过邮箱处理非周期性命令的单元。PDOs需要分配到SM上来进行数据交换；ESI同时也包括现场总线内存管理单元FMMU (Fieldbus Memory Management Unit)，它是内存映射至过程数据逻辑地址区域的单元，同时一个EEPROM用于存储从站设置。

EtherCAT协议同时也定义了很多用于通讯的子协议与设备规约，常见的协议如下：
* CoE: CANopen over EtherCAT。基于EtherCAT协议的CANopen通讯规约
* EoE: Ethernet over EtherCAT。基于EtherCAT协议以太网通讯
* FoE: File access over EtherCAT。基于EtherCAT协议的文件访问
* SoE: Sercos over EtherCAT。基于EtherCAT协议的Sercos通讯规约
* FSoE: Safety over EtherCAT。基于EtherCAT协议的安全通讯规约


快速入门
------------
通过以下步骤可以快速上手EtherCAT总线配置与应用，每一步都将在后续章节详细说明:

1. 通过"Enabled"选择框使能EtherCAT主站

2. 导入所有必要的EtherCAT从站ESI文件（该文件请与EtherCAT从站设备供应商联系）

3. 在主站的"Main network"中添加所有从站设备, 或者启动Online在线模式进行在线"Scan network"功能

4. 通过手动或者在线模式配置从站slot以及modules（如果当前从站设备不存在slot以及modules配置，请忽略此步骤）

5. 配置分布式时钟DC与控制器支持的总线周期

6. 配置PDO以及关联PLC变量与PDO对象

7. 编译与下载工程使得EtherCAT配置生效


导入ESI文件
------------
为了配置EtherCAT网络，第一步需要做的就是导入所有您需要使用的从站设备ESI文件。

为了导入ESI文件，需要选择目录 ``工具/导入ESI`` ，然后从文件系统中选择并导入一个正确的ESI文件，并在ESI设备列表中选择需要导入的一个或者多个设备。

.. figure:: images/logiclab_fieldbus/ethercat/logiclab_fieldbus_ethercat_1.jpg
   :align: center

   ESI文件导入

ESI文件通常是以.xml格式为扩展名的文件，但是需要注意的是一个主ESI文件中可能内部链接了若干包含了设备描述的子ESI文件，需要与您的设备供应商确定该ESI文件的组成。


EtherCAT主站配置
----------------
在资源窗口里面点击EtherCAT节点，打开EtherCAT主站设置窗口，在这里您可以设置所有的EtherCAT主站参数。.

通用选项
^^^^^^^^^^^


.. figure:: images/logiclab_fieldbus/ethercat/logiclab_fieldbus_ethercat_2.png
   :align: center
   :name: my-figure

   选项


